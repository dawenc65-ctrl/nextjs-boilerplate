// app/api/webhook/route.ts
export async function POST(request: Request) {
  try {
    // 1. ä»è¯·æ±‚ä¸­è·å–JSONæ•°æ®
    const data = await request.json();

    // 2. ã€æå…¶é‡è¦ã€‘å®‰å…¨éªŒè¯ï¼æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦åŒ¹é…
    const secretToken = process.env.SECRET_TOKEN;
    if (data.token !== secretToken) {
      console.error('Unauthorized request. Token received:', data.token);
      // è¿”å› 401 æœªæˆæƒé”™è¯¯
      return Response.json({ error: 'Unauthorized' }, { status: 401 });
    }

    // 3. æå–TradingViewå‘é€çš„æ•°æ® (è¿™äº›å­—æ®µéœ€è¦å’Œæ‚¨åœ¨TradingViewè­¦æŠ¥ä¸­è®¾ç½®çš„JSONé”®ååŒ¹é…)
    const { symbol, price, time, action, message } = data;

    // 4. æ ¸å¿ƒé€»è¾‘ï¼šæ‰“å°æ—¥å¿—
    console.log('âœ… Webhook Received:', { symbol, price, time, action });

    // 5. è¿™é‡Œæ·»åŠ æ‚¨çš„å¤„ç†é€»è¾‘ï¼Œä¾‹å¦‚å‘é€åˆ°Telegramã€è°ƒç”¨æ¨¡å‹ã€æˆ–æ‰§è¡Œäº¤æ˜“
    if (action) {
      // è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹å‡½æ•°ï¼Œæ‚¨éœ€è¦å®ç°è‡ªå·±çš„é€»è¾‘
      await processTradingSignal(symbol, price, action, message);
    }

    // 6. è¿”å›æˆåŠŸçš„å“åº”ç»™TradingView
    return Response.json({ status: 'success', message: 'Signal received and processed.' });

  } catch (error) {
    // æ•è·ä»»ä½•æ„å¤–é”™è¯¯
    console.error('âŒ Error processing webhook:', error);
    return Response.json({ error: 'Internal Server Error' }, { status: 500 });
  }
}

// è¾…åŠ©å‡½æ•°ï¼šå¤„ç†äº¤æ˜“ä¿¡å·ï¼ˆç¤ºä¾‹ï¼šå‘é€åˆ°Telegramï¼‰
async function processTradingSignal(symbol: string, price: number, action: string, message?: string) {
  // æ‚¨çš„é€»è¾‘åœ¨è¿™é‡Œ
  console.log(ğŸ¤– Processing ${action} signal for ${symbol} at ${price});

  // ç¤ºä¾‹ï¼šå‘é€åˆ°Telegram (éœ€è¦é…ç½®ç¯å¢ƒå˜é‡)
  const botToken = process.env.TELEGRAM_BOT_TOKEN;
  const chatId = process.env.TELEGRAM_CHAT_ID;

  if (botToken && chatId) {
    const text = `ğŸš€ TradingView Alert \\- ${action}
    \\- Symbol: ${symbol}
    \\- Price: ${price}
    \\- Message: ${message || 'No additional message'}`;

    const telegramUrl = https://api.telegram.org/bot${botToken}/sendMessage;

    try {
      const response = await fetch(telegramUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          chat_id: chatId,
          text: text,
          parse_mode: 'MarkdownV2',
        }),
      });
      const data = await response.json();
      console.log('Telegram message sent:', data.ok);
    } catch (tgError) {
      console.error('Failed to send Telegram message:', tgError);
    }
  }
}

// å¯é€‰ï¼šåŒæ ·å…è®¸GETè¯·æ±‚ç”¨äºæµ‹è¯•ï¼Œä½†TradingViewåªä¼šç”¨POST
export async function GET() {
  return Response.json({ message: 'Webhook endpoint is live and ready for POST requests from TradingView!' });
}
